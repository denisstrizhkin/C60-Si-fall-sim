FROM gentoo/stage3:nomultilib

RUN emerge-webrsync && emerge --sync

RUN rmdir /etc/portage/{package.use,package.accept_keywords,package.mask} \
  && echo 'FEATURES="-ipc-sandbox -network-sandbox -pid-sandbox"' >> /etc/portage/make.conf

RUN echo 'sci-physics/lammps' > /etc/portage/package.accept_keywords

RUN echo 'sci-physics/lammps extra mpi opencl openmp python' > /etc/portage/package.use \
  && echo 'sci-libs/netcdf mpi' >> /etc/portage/package.use \
  && echo 'sci-libs/hdf5 mpi' >> /etc/portage/package.use \
  && echo 'virtual/mpi romio' >> /etc/portage/package.use

RUN emerge -j 5 lammps

RUN echo 'dev-python/pillow webp' >> /etc/portage/package.use \
  && echo 'virtual/imagemagick-tools tiff jpeg' >> /etc/portage/package.use \
  && echo 'media-gfx/imagemagick tiff jpeg' >> /etc/portage/package.use

RUN emerge -j 5 numpy matplotlib virtualenv

RUN rm -rf /var/cache/distfiles \
  && emerge -c
